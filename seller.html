<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Sledneck Shiners — Seller</title>
    <meta name="theme-color" content="#0b2a5a"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <style>
      button, input, select, textarea { font-size: 16px; }
      .pill { border:1px solid #e5e7eb; border-radius:999px; padding:6px 12px; }
      .pill-green { background:#16a34a; color:white; border-color:#16a34a; }
      .pill-red   { background:#dc2626; color:white; border-color:#dc2626; }
      .pill-muted { background:#ffffff; color:#111827; }
      .badge { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb }
      .badge-warn { background:#fef3c7; color:#92400e; border-color:#fde68a }
      .badge-ok { background:#dcfce7; color:#166534; border-color:#bbf7d0 }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>
    <script>
      const { useEffect, useMemo, useState } = React;

      // ---- YOUR CONFIG ----
      const SUPABASE_URL = "https://hsnmgpjzdjebjobayufq.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzbm1ncGp6ZGplYmpvYmF5dWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTEwNTksImV4cCI6MjA3NjI2NzA1OX0.BGJvJnREimmAmUZ4ltKwhWA4JBcTHN1T_GMIYE1m-4E";
      const SELLER_ID = "sledneck";
      const LAKES = ["Cheshire Lake","Plainfield Pond","Windsor Pond","Onota Lake","Pontoosuc Lake"];

      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Friendly buyer label (never show “placeholder”)
      function displayCatName(c){
        if (c.id === 'placeholder') return 'Out of Stock';
        return c.name || c.id.replace(/_/g,' ').replace(/\b\w/g, s=>s.toUpperCase());
      }

      function App(){
        // Auth
        const [session, setSession] = useState(null);
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [authErr, setAuthErr] = useState("");

        // Data
        const [lakeOpenMap, setLakeOpenMap] = useState({}); // { lake: boolean }
        const [selectedLake, setSelectedLake] = useState(LAKES[0]);
        const [categories, setCategories] = useState([]);
        const [orders, setOrders] = useState([]);
        const [lowStockThreshold, setLowStockThreshold] = useState(10);

        // Toast
        const [toast, setToast] = useState("");

        function showToast(msg){
          setToast(msg);
          setTimeout(()=> setToast(""), 1500);
        }

        // Auth state
        useEffect(()=>{
          supa.auth.getSession().then(({ data })=> setSession(data.session || null));
          const { data: sub } = supa.auth.onAuthStateChange((_ev, s)=> setSession(s));
          return ()=> sub.subscription.unsubscribe();
        }, []);

        // Load + realtime after login
        useEffect(()=>{
          if (!session) return;
          (async ()=>{
            await Promise.all([loadLakeStatus(), loadCategories(), loadOrders()]);

            supa.channel("lake-status-"+SELLER_ID)
              .on("postgres_changes",{event:"*",schema:"public",table:"seller_lake_status",filter:`seller_id=eq.${SELLER_ID}`},
                ()=> loadLakeStatus())
              .subscribe();

            supa.channel("cats-"+SELLER_ID)
              .on("postgres_changes",{event:"*",schema:"public",table:"categories",filter:`seller_id=eq.${SELLER_ID}`},
                ()=> loadCategories())
              .subscribe();

            supa.channel("orders-"+SELLER_ID)
              .on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:`seller_id=eq.${SELLER_ID}`},
                ()=> loadOrders())
              .subscribe();
          })();
        }, [session]);

        async function signIn(e){
          e?.preventDefault?.();
          setAuthErr("");
          const { data, error } = await supa.auth.signInWithPassword({ email: email.trim(), password });
          if (error) { setAuthErr(error.message); return; }
          setSession(data.session);
        }
        async function signOut(){ await supa.auth.signOut(); setSession(null); }

        // Loaders
        async function loadLakeStatus(){
          const { data, error } = await supa
            .from("seller_lake_status")
            .select("*")
            .eq("seller_id", SELLER_ID);
          if (error) { console.error(error); return; }
          const map={};
          for (const row of (data||[])) map[row.lake]=!!row.is_open;
          for (const L of LAKES) if (!(L in map)) map[L]=false;
          setLakeOpenMap(map);
          if (!LAKES.includes(selectedLake)) setSelectedLake(LAKES[0]);
        }

        async function loadCategories(){
          const { data } = await supa.from("categories").select("*").eq("seller_id", SELLER_ID);
          const list = (data || []);
          // Sort: Out of Stock first, then small/medium/large/goldfish, then others A→Z
          const orderMap = { placeholder:1, small:2, medium:3, large:4, goldfish:5 };
          list.sort((a,b)=>{
            const sa = orderMap[a.id] ?? (100 + a.id.localeCompare(b.id));
            const sb = orderMap[b.id] ?? (100 + b.id.localeCompare(a.id));
            return sa - sb;
          });
          setCategories(list);
        }

        async function loadOrders(){
          const { data } = await supa
            .from("orders")
            .select("*")
            .eq("seller_id", SELLER_ID)
            .order("created_at", { ascending:false });
          setOrders(data || []);
        }

        // Saves
        async function saveLakeOpen(lake, is_open){
          const payload = { seller_id: SELLER_ID, lake, is_open };
          const { error } = await supa
            .from("seller_lake_status")
            .upsert(payload, { onConflict: 'seller_id,lake' });
          if (error) { alert("Failed to update lake status: " + error.message); return; }
          await loadLakeStatus();
          showToast(`Saved: ${lake} → ${is_open ? "Open" : "Closed"}`);
        }

        async function saveCategory(cat){
          const payload = {
            id: String(cat.id || "").trim(),
            seller_id: SELLER_ID,
            name: displayCatName(cat),
            unit: "each",
            price: Number(cat.price ?? 0),
            description: (cat.description || "").toString(),
            disabled: !!cat.disabled,
            stock: (cat.stock === "" || cat.stock === null || cat.stock === undefined)
              ? null
              : Number(cat.stock)
          };
          if (!payload.id) { alert("ID is required."); return; }

          const { error } = await supa
            .from("categories")
            .upsert(payload, { onConflict: 'seller_id,id' });

          if (error) { alert("Save failed: " + error.message + "\n(If it mentions 'stock', run: ALTER TABLE public.categories ADD COLUMN IF NOT EXISTS stock integer;)"); return; }

          // Pull back the latest to reflect DB truth
          await loadCategories();
          showToast("Saved ✓");
        }

        async function addCategory(){
          const id = prompt("New category ID (e.g., smallplus, shiner_xl):");
          if (!id) return;
          await saveCategory({ id, price: 0, description: "", disabled: false, stock: 0 });
        }

        async function recomputeDailyDeal(){
          const base = categories.filter(c=> ["small","medium","large","goldfish"].includes(c.id));
          const baseSum = base.reduce((a,c)=> a + Number(c.price||0), 0);
          const price = Math.round(0.75 * 5 * baseSum * 100) / 100;
          await saveCategory({
            id: "daily_deal",
            price,
            description: "Bundle: 5 Small + 5 Medium + 5 Large + 5 Goldfish at 3/4 price.",
            disabled: false
          });
          showToast("Daily Deal → $" + price.toFixed(2));
        }

        async function soldOutAll(){
          if (!confirm("Mark every category Out of stock and set ALL lakes to Closed?")) return;
          const { error } = await supa.from("categories").update({ disabled:true }).eq("seller_id", SELLER_ID);
          if (error) { alert("Failed to disable categories: " + error.message); return; }
          for (const L of LAKES) await saveLakeOpen(L, false);
          await loadCategories();
          await loadLakeStatus();
          alert("All items Out of stock and all lakes Closed.");
        }

        async function setOrderStatus(id, status){
          const { error } = await supa
            .from("orders")
            .update({ status })
            .eq("seller_id", SELLER_ID)
            .eq("id", id);
          if (error) {
            alert("Update failed: " + error.message);
            await loadCategories();
            return;
          }
          await loadCategories(); // reflect stock changes on Accept/Cancel
          showToast(`Order ${id} → ${status}`);
        }

        function exportOrdersCSV(){
          const headers = ["order_id","buyer_name","lake","status","created_at","lat","lng","category_id","qty","notes"];
          const rows = [];
          for (const o of orders){
            const lat = o.location && o.location.lat != null ? o.location.lat : "";
            const lng = o.location && o.location.lng != null ? o.location.lng : "";
            const items = Array.isArray(o.items) ? o.items : [];
            if (items.length === 0){
              rows.push([o.id,o.buyer_name||"",o.lake||"",o.status||"",o.created_at||"",lat,lng,"",0,o.notes||""]);
            } else {
              for (const it of items){
                rows.push([o.id,o.buyer_name||"",o.lake||"",o.status||"",o.created_at||"",lat,lng,it.category_id||"",it.qty||0,o.notes||""]);
              }
            }
          }
          const csv = [headers.join(","), ...rows.map(r=> r.map(v=>{
            const s = String(v).replaceAll('"','""');
            return /[",\n]/.test(s) ? `"${s}"` : s;
          }).join(","))].join("\n");
          const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = "orders.csv";
          document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
        }

        const lowStockCats = useMemo(()=>{
          return categories.filter(c=>{
            const s = Number(c.stock);
            return !isNaN(s) && s >= 0 && s <= Number(lowStockThreshold) && !c.disabled;
          });
        }, [categories, lowStockThreshold]);

        if (!session){
          return (
            React.createElement("div",{className:"min-h-screen flex items-center justify-center p-4"},
              React.createElement("div",{className:"max-w-sm w-full bg-white p-6 rounded-2xl shadow"},
                React.createElement("div",{className:"text-2xl font-bold mb-2 text-center"}, "Sledneck Shiners — Seller"),
                React.createElement("p",{className:"text-sm text-slate-600 mb-4 text-center"}, "Sign in with your seller account."),
                authErr && React.createElement("div",{className:"text-red-600 text-sm mb-2"}, authErr),
                React.createElement("form",{onSubmit:signIn, className:"grid gap-3"},
                  React.createElement("input",{className:"border rounded-xl px-3 py-2", type:"email", placeholder:"Email", value:email, onChange:e=>setEmail(e.target.value)}),
                  React.createElement("input",{className:"border rounded-xl px-3 py-2", type:"password", placeholder:"Password", value:password, onChange:e=>setPassword(e.target.value)}),
                  React.createElement("button",{className:"px-4 py-2 rounded-xl bg-slate-900 text-white", type:"submit"}, "Sign In")
                )
              )
            )
          );
        }

        // ---- UI ----
        return (
          React.createElement("div",{className:"min-h-screen p-4"},
            React.createElement("div",{className:"max-w-5xl mx-auto space-y-4"},

              // Header + actions
              React.createElement("div",{className:"flex items-center justify-between"},
                React.createElement("h1",{className:"text-2xl font-bold"},"Seller Dashboard"),
                React.createElement("div",{className:"flex flex-wrap gap-2"},
                  React.createElement("a",{href:"./", className:"px-3 py-2 rounded-lg bg-white border"},"Buyer Page"),
                  React.createElement("button",{onClick:exportOrdersCSV, className:"px-3 py-2 rounded-lg bg-white border"},"Export orders CSV"),
                  React.createElement("button",{onClick:soldOutAll, className:"px-3 py-2 rounded-lg bg-red-600 text-white"},"Sold out all")
                )
              ),

              <!-- Per-lake Open/Closed -->
              React.createElement("div",{className:"bg-white rounded-2xl p-5 shadow"},
                React.createElement("h2",{className:"text-lg font-semibold mb-3"},"Lake Open/Closed"),
                React.createElement("div",{className:"grid sm:grid-cols-4 gap-3"},
                  React.createElement("div",null,
                    React.createElement("label",{className:"text-sm text-slate-600"},"Lake"),
                    React.createElement("select",{className:"w-full border rounded-xl px-3 py-2 mt-1",
                      value:selectedLake, onChange:e=>setSelectedLake(e.target.value)},
                      LAKES.map(L=> React.createElement("option",{key:L,value:L},L))
                    )
                  ),
                  React.createElement("div",{className:"sm:col-span-2 flex items-end"},
                    React.createElement("button",{
                      className:"w-full pill " + (lakeOpenMap[selectedLake] ? "pill-green" : "pill-red"),
                      onClick:()=> saveLakeOpen(selectedLake, !lakeOpenMap[selectedLake])
                    }, lakeOpenMap[selectedLake] ? "Open (customers see OPEN)" : "Closed (customers see CLOSED)")
                  ),
                  React.createElement("div",null,
                    React.createElement("label",{className:"text-sm text-slate-600"},"Low-stock threshold"),
                    React.createElement("input",{type:"number", min:"0", className:"w-full border rounded-xl px-3 py-2 mt-1", value:lowStockThreshold, onChange:e=>setLowStockThreshold(e.target.value)})
                  )
                ),
                React.createElement("div",{className:"mt-4"},
                  lowStockCats.length>0
                    ? React.createElement("div",{className:"p-3 rounded-xl border bg-amber-50 text-amber-900"},
                        `${lowStockCats.length} low-stock: ` +
                        lowStockCats.map(c=> displayCatName(c) + (c.stock!=null?` (${c.stock})`:"")).join(", ")
                      )
                    : React.createElement("div",{className:"p-3 rounded-xl border bg-emerald-50 text-emerald-900"},"All good — no low stock.")
                )
              ),

              // Categories
              React.createElement("div",{className:"bg-white rounded-2xl p-5 shadow"},
                React.createElement("div",{className:"flex items-center justify-between mb-3"},
                  React.createElement("h2",{className:"text-lg font-semibold"},"Categories"),
                  React.createElement("div",{className:"flex gap-2"},
                    React.createElement("button",{className:"px-3 py-2 rounded-lg bg-white border", onClick:addCategory},"Add Category"),
                    React.createElement("button",{className:"px-3 py-2 rounded-lg bg-white border", onClick:recomputeDailyDeal},"Recompute Daily Deal")
                  )
                ),
                categories.length===0
                  ? React.createElement("div",{className:"text-sm text-slate-500"},"No categories yet.")
                  : React.createElement("div",{className:"grid gap-3"},
                      categories.map(c=> React.createElement("div",{key:c.id, className:"border rounded-2xl p-3"},
                        React.createElement("div",{className:"grid sm:grid-cols-6 gap-2 items-center"},
                          React.createElement("div",{className:"sm:col-span-2"},
                            React.createElement("div",{className:"text-xs text-slate-500"},"ID"),
                            React.createElement("input",{className:"w-full border rounded-lg px-3 py-2", value:c.id, onChange:e=>setCategories(prev=>prev.map(x=> x.id===c.id? {...x, id:e.target.value}: x))}),
                            React.createElement("div",{className:"text-xs text-slate-500 mt-1"},"Buyer label: ", displayCatName(c))
                          ),
                          React.createElement("div",null,
                            React.createElement("div",{className:"text-xs text-slate-500"},"Price ($/each)"),
                            React.createElement("input",{type:"number", step:"0.01", min:"0", className:"w-full border rounded-lg px-3 py-2", value:c.price||0, onChange:e=>setCategories(prev=>prev.map(x=> x.id===c.id? {...x, price:Number(e.target.value)}: x))})
                          ),
                          React.createElement("div",null,
                            React.createElement("div",{className:"text-xs text-slate-500"},"Stock (each)"),
                            React.createElement("input",{type:"number", step:"1", min:"0", className:"w-full border rounded-lg px-3 py-2", value:c.stock ?? "", onChange:e=>setCategories(prev=>prev.map(x=> x.id===c.id? {...x, stock: e.target.value===""? null : Number(e.target.value)}: x))})
                          ),
                          React.createElement("div",{className:"sm:col-span-2 flex items-end justify-end"},
                            React.createElement("button",{
                              className:"pill " + (c.disabled ? "pill-red" : "pill-muted"),
                              onClick:()=> setCategories(prev=>prev.map(x=> x.id===c.id? {...x, disabled: !x.disabled}: x))
                            }, c.disabled ? "Out of stock" : "In stock")
                          )
                        ),
                        React.createElement("div",{className:"mt-2"},
                          React.createElement("div",{className:"text-xs text-slate-500"},"Description"),
                          React.createElement("textarea",{rows:2, className:"w-full border rounded-lg px-3 py-2", value:c.description||"", onChange:e=>setCategories(prev=>prev.map(x=> x.id===c.id? {...x, description:e.target.value}: x))})
                        ),
                        React.createElement("div",{className:"mt-2 flex justify-end"},
                          React.createElement("button",{className:"px-3 py-2 rounded-lg bg-slate-900 text-white", onClick:()=>saveCategory(c)},"Save")
                        )
                      ))
                    )
              ),

              // Orders
              React.createElement("div",{className:"bg-white rounded-2xl p-5 shadow"},
                React.createElement("div",{className:"flex items-center justify-between mb-3"},
                  React.createElement("h2",{className:"text-lg font-semibold"},"Orders (realtime)")
                ),
                orders.length===0
                  ? React.createElement("div",{className:"text-sm text-slate-500"},"No orders yet.")
                  : React.createElement("div",{className:"grid gap-3"},
                      orders.map(o=> React.createElement("div",{key:o.id, className:"border rounded-2xl p-3"},
                        React.createElement("div",{className:"flex items-center justify-between"},
                          React.createElement("div",{className:"font-semibold"}, o.id, " · ",
                            React.createElement("span",{className:"text-slate-500"}, o.buyer_name || "—"), " · ",
                            React.createElement("span",{className:"text-slate-500"}, o.lake || "—")
                          ),
                          React.createElement("div",null, o.status)
                        ),
                        React.createElement("div",{className:"text-xs text-slate-600 mt-1"},
                          o.location && o.location.lat ? `Pin: ${o.location.lat.toFixed?.(6)}, ${o.location.lng.toFixed?.(6)}` : "No pin"
                        ),
                        React.createElement("ul",{className:"list-disc pl-5 text-sm mt-2"},
                          (o.items||[]).map((it,idx)=> React.createElement("li",{key:idx}, `${it.category_id} × ${it.qty}`))
                        ),
                        React.createElement("div",{className:"text-sm mt-2"}, o.notes || "—"),
                        React.createElement("div",{className:"mt-3 flex flex-wrap gap-2"},
                          o.status==="pending" && React.createElement("button",{className:"px-3 py-2 rounded-lg bg-slate-900 text-white", onClick:()=>setOrderStatus(o.id,"accepted")},"Accept"),
                          o.status==="accepted" && React.createElement("button",{className:"px-3 py-2 rounded-lg bg-white border", onClick:()=>setOrderStatus(o.id,"on_the_way")},"On The Way"),
                          (o.status==="accepted" || o.status==="on_the_way") && React.createElement("button",{className:"px-3 py-2 rounded-lg bg-white border", onClick:()=>setOrderStatus(o.id,"canceled")},"Cancel"),
                          o.status==="on_the_way" && React.createElement("button",{className:"px-3 py-2 rounded-lg bg-slate-900 text-white", onClick:()=>setOrderStatus(o.id,"fulfilled")},"Fulfill")
                        )
                      ))
                    )
              )
            ),
            toast && React.createElement("div", { className:"fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white rounded-full px-4 py-2 shadow" }, toast)
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
