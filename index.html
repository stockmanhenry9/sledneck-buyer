<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sledneck Shiners - Buyer</title>
    <meta name="theme-color" content="#0b2a5a"/>

    <!-- UI + React -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Supabase (UMD build) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <!-- Leaflet (maps) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <style>
      button, input, select { font-size: 16px; }
      #map { height: 320px; }
      @media (min-width: 640px) { #map { height: 420px; } }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>
    <script>
      const { useEffect, useMemo, useRef, useState } = React;

      // ---- Config (yours) ----
      const SUPABASE_URL = "https://hsnmgpjzdjebjobayufq.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzbm1ncGp6ZGplYmpvYmF5dWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTEwNTksImV4cCI6MjA3NjI2NzA1OX0.BGJvJnREimmAmUZ4ltKwhWA4JBcTHN1T_GMIYE1m-4E";
      const SELLER_ID = "sledneck";

      const DEFAULT_CENTER = [42.561, -73.159]; // Cheshire Lake approx center
      const DEFAULT_ZOOM = 14;

      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function normalizeIntInput(s){
        const n = Math.max(0, Math.floor(Number(String(s).replace(/[^0-9]/g,""))));
        return String(n);
        }

      function App(){
        const [status, setStatus] = useState({ is_open:false, lake:"" });
        const [categories, setCategories] = useState([]);
        const [cart, setCart] = useState({});
        const [buyerName, setBuyerName] = useState("");
        const [buyerNotes, setBuyerNotes] = useState("");
        const [pin, setPin] = useState(null); // { lat, lng }
        const [confirm, setConfirm] = useState(null);

        // Review form state
        const [revName, setRevName] = useState("");
        const [revStars, setRevStars] = useState(5);
        const [revText, setRevText] = useState("");

        // Initial fetch + realtime
        useEffect(()=>{
          async function fetchData(){
            const { data: st } = await supa.from("seller_status").select("*").eq("seller_id", SELLER_ID).maybeSingle();
            if (st) setStatus({ is_open: !!st.is_open, lake: st.lake || "" });

            const { data: cats } = await supa.from("categories").select("*").eq("seller_id", SELLER_ID);
            if (cats) setCategories(sortCats(cats));
          }
          fetchData();

          const chStatus = supa.channel("status-"+SELLER_ID)
            .on("postgres_changes",{ event:"*", schema:"public", table:"seller_status", filter:`seller_id=eq.${SELLER_ID}` }, payload=>{
              const st = payload.new || payload.old || {};
              setStatus({ is_open: !!st.is_open, lake: st.lake || "" });
            }).subscribe();

          const chCats = supa.channel("cats-"+SELLER_ID)
            .on("postgres_changes",{ event:"*", schema:"public", table:"categories", filter:`seller_id=eq.${SELLER_ID}` }, ()=>{
              supa.from("categories").select("*").eq("seller_id", SELLER_ID).then(({data})=>{
                if (data) setCategories(sortCats(data));
              });
            }).subscribe();

          return ()=>{ supa.removeChannel(chStatus); supa.removeChannel(chCats); }
        }, []);

        function sortCats(list){
          // Put 'small' first, then 'placeholder', then medium/large/goldfish, then others alpha
          const order = { small:1, placeholder:2, medium:3, large:4, goldfish:5 };
          return [...list].sort((a,b)=>{
            const sa = order[a.id] ?? (100 + a.id.localeCompare(b.id));
            const sb = order[b.id] ?? (100 + b.id.localeCompare(a.id));
            return sa - sb;
          });
        }

        const canOrderHere = status.is_open;

        function setCartQty(id, qty){
          setCart(prev => {
            const q = Math.max(0, Math.floor(qty));
            const next = {...prev};
            if (q===0) delete next[id]; else next[id]=q;
            return next;
          });
        }

        const cartTotal = useMemo(()=>{
          let t=0;
          for (const [id,qty] of Object.entries(cart)){
            const c = categories.find(x=>x.id===id);
            if (!c) continue;
            t += (c.price || 0)*qty;
          }
          return t;
        }, [cart, categories]);

        async function placeOrder(){
          if (!canOrderHere) return alert("Seller is not open right now.");
          if (!pin) return alert("Location is required: tap the map or use GPS.");
          if (!buyerName.trim()) return alert("Please enter your name.");

          const items = Object.entries(cart).map(([category_id, qty]) => ({ category_id, qty })).filter(x=>x.qty>0);
          if (items.length===0) return alert("Add at least one item.");

          const order = {
            id: "ORD-"+Date.now(),
            seller_id: SELLER_ID,
            lake: status.lake || "",
            status: "pending",
            items,
            notes: buyerNotes,
            buyer_name: buyerName.trim(),
            location: pin, // {lat,lng}
            created_at: new Date().toISOString()
          };
          const { error } = await supa.from("orders").insert(order);
          if (error) { alert("Order failed: "+error.message); return; }
          setCart({}); setBuyerNotes(""); setConfirm(order);
        }

        async function submitReview(){
          if (!buyerName.trim() && !revName.trim()){
            alert("Please enter a name for your review.");
            return;
          }
          const payload = {
            seller_id: SELLER_ID,
            buyer_name: (revName || buyerName || "Anonymous").trim(),
            stars: Number(revStars)||5,
            text: (revText||"").trim()
          };
          const { error } = await supa.from("reviews").insert(payload);
          if (error){ alert("Review failed: " + error.message); return; }
          setRevText("");
          alert("Thanks! Your review was sent to the seller.");
        }

        return (
          React.createElement("div",{className:"min-h-screen p-4"},
            React.createElement("div",{className:"max-w-3xl mx-auto space-y-4"},

              // Header
              React.createElement("div",{className:"rounded-2xl shadow p-5 bg-white"},
                React.createElement("h1",{className:"text-xl font-semibold mb-1"},"Sledneck Shiners - Buyer"),
                React.createElement("div",{className:"text-sm text-slate-600"},
                  "Lake: ", status.lake || "—", " · Seller is ",
                  canOrderHere ? "OPEN" : "CLOSED"
                )
              ),

              // Location
              React.createElement(LocationSection, {
                pin, setPin, defaultCenter: DEFAULT_CENTER, defaultZoom: DEFAULT_ZOOM
              }),

              // Build order
              React.createElement("div",{className:"rounded-2xl shadow p-5 bg-white"},
                React.createElement("h2",{className:"text-lg font-semibold mb-3"},"Build Your Order"),
                categories.length===0
                  ? React.createElement("div",{className:"text-sm text-slate-500"},"No categories yet.")
                  : React.createElement("div",{className:"grid gap-3"},
                      categories.map(c=> React.createElement("div",{key:c.id, className:"border rounded-2xl p-3 "+(c.disabled?"opacity-50":"")},
                        React.createElement("div",{className:"flex items-center justify-between"},
                          React.createElement("div",null,
                            React.createElement("div",{className:"font-medium"}, c.name || c.id),
                            React.createElement("div",{className:"text-xs text-slate-500"}, "Price: $", (c.price||0).toFixed(2), " each")
                          ),
                          React.createElement("input",{
                            type:"text", inputMode:"numeric", pattern:"[0-9]*",
                            className:"w-20 border rounded-lg px-3 py-2",
                            value:String(cart[c.id]||0),
                            onChange:(e)=> setCartQty(c.id, Number(normalizeIntInput(e.target.value))),
                            disabled:!canOrderHere || c.disabled
                          })
                        ),
                        c.description ? React.createElement("div",{className:"text-xs text-slate-600 mt-2"}, c.description) : null
                      ))
                    ),

                // Buyer info & submit
                React.createElement("div",{className:"grid sm:grid-cols-2 gap-3 mt-4"},
                  React.createElement("div",null,
                    React.createElement("label",{className:"text-sm text-slate-600"},"Your Name (required)"),
                    React.createElement("input",{className:"w-full border rounded-xl px-3 py-2 mt-1", value:buyerName, onChange:e=>setBuyerName(e.target.value), placeholder:"First name or nickname"})
                  ),
                  React.createElement("div",null,
                    React.createElement("label",{className:"text-sm text-slate-600"},"Notes (optional)"),
                    React.createElement("input",{className:"w-full border rounded-xl px-3 py-2 mt-1", value:buyerNotes, onChange:e=>setBuyerNotes(e.target.value), placeholder:""})
                  )
                ),

                React.createElement("div",{className:"mt-3 p-3 rounded-xl bg-slate-100 flex items-center justify-between"},
                  React.createElement("div",{className:"text-sm"},"Cart total estimate"),
                  React.createElement("div",{className:"text-lg font-semibold"},"$", cartTotal.toFixed(2))
                ),
                React.createElement("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mt-4"},
                  React.createElement("div",{className:"text-sm text-slate-600"},"Status: ", canOrderHere ? "Open here" : "Closed here"),
                  React.createElement("div",{className:"flex items-center gap-3"},
                    React.createElement("div",{className:"text-sm text-slate-600"},"Cash or card accepted at delivery"),
                    React.createElement("button",{onClick:placeOrder, className:"px-4 py-2 rounded-xl bg-slate-900 text-white", disabled:!canOrderHere},"Place Order")
                  )
                )
              ),

              // Private review submit (insert-only)
              React.createElement("div",{className:"rounded-2xl shadow p-5 bg-white"},
                React.createElement("h2",{className:"text-lg font-semibold mb-3"},"Leave a Review (private to seller)"),
                React.createElement("div",{className:"grid sm:grid-cols-3 gap-3"},
                  React.createElement("div",null,
                    React.createElement("label",{className:"text-sm text-slate-600"},"Name"),
                    React.createElement("input",{className:"w-full border rounded-xl px-3 py-2 mt-1", value:revName, onChange:e=>setRevName(e.target.value), placeholder: buyerName || "Your name"})
                  ),
                  React.createElement("div",null,
                    React.createElement("label",{className:"text-sm text-slate-600"},"Stars"),
                    React.createElement("select",{className:"w-full border rounded-xl px-3 py-2 mt-1", value:revStars, onChange:e=>setRevStars(e.target.value)},
                      [1,2,3,4,5].map(s=> React.createElement("option",{key:s, value:s}, s))
                    )
                  ),
                  React.createElement("div",{className:"sm:col-span-1"})
                ),
                React.createElement("div",{className:"mt-3"},
                  React.createElement("label",{className:"text-sm text-slate-600"},"Review"),
                  React.createElement("textarea",{rows:3, className:"w-full border rounded-xl px-3 py-2 mt-1", value:revText, onChange:e=>setRevText(e.target.value), placeholder:"How was your experience?"})
                ),
                React.createElement("div",{className:"mt-3 flex justify-end"},
                  React.createElement("button",{className:"px-4 py-2 rounded-xl bg-slate-900 text-white", onClick:submitReview},"Submit Review")
                ),
                React.createElement("p",{className:"text-xs text-slate-500 mt-2"},"Reviews are not public in this version; only the seller can read them.")
              ),

              // Confirmation
              confirm && React.createElement("div",{className:"rounded-2xl shadow p-5 bg-white"},
                React.createElement("h2",{className:"text-lg font-semibold mb-1"},"Order Received"),
                React.createElement("div",{className:"text-sm"},"Thanks, ", confirm.buyer_name, "! Your order ", confirm.id, " has been received."),
                React.createElement("div",{className:"mt-3 flex justify-end"},
                  React.createElement("button",{className:"px-4 py-2 rounded-xl bg-slate-900 text-white", onClick:()=>setConfirm(null)},"Done")
                )
              ),

              React.createElement("div",{className:"text-xs text-slate-500"},
                "Map imagery © Esri, Maxar, Earthstar Geographics, and contributors. Location is shared only with the seller for this order."
              )
            )
          )
        );
      }

      // --- Aerial Map component using Leaflet ---
      function LocationSection({ pin, setPin, defaultCenter, defaultZoom }){
        const mapRef = useRef(null);
        const markerRef = useRef(null);

        useEffect(()=>{
          if (mapRef.current) return; // init once

          const map = L.map('map', {
            center: defaultCenter,
            zoom: defaultZoom,
            zoomControl: true,
          });

          // Esri World Imagery (no key required)
          L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            {
              attribution: 'Tiles &copy; Esri &mdash; Sources: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
            }
          ).addTo(map);

          // Click to drop/move pin
          map.on('click', (e)=>{
            const { lat, lng } = e.latlng;
            placeOrMoveMarker(lat, lng);
          });

          mapRef.current = map;

          function placeOrMoveMarker(lat, lng){
            if (!markerRef.current){
              markerRef.current = L.marker([lat,lng], { draggable: true }).addTo(mapRef.current);
              markerRef.current.on('dragend', (ev)=>{
                const ll = ev.target.getLatLng();
                setPin({ lat: round6(ll.lat), lng: round6(ll.lng) });
              });
            } else {
              markerRef.current.setLatLng([lat,lng]);
            }
            setPin({ lat: round6(lat), lng: round6(lng) });
          }

          // expose helper for GPS button
          mapRef.current._placeOrMoveMarker = placeOrMoveMarker;

          function round6(x){ return Math.round(x * 1e6) / 1e6; }
        }, [defaultCenter, defaultZoom, setPin]);

        async function useGPS(){
          if (!navigator.geolocation) { alert("Geolocation not supported."); return; }
          navigator.geolocation.getCurrentPosition(
            (pos)=>{
              const { latitude, longitude } = pos.coords;
              const map = mapRef.current;
              if (!map) return;
              map.setView([latitude, longitude], 16, { animate: true });
              map._placeOrMoveMarker(latitude, longitude);
            },
            (err)=> alert("GPS error: " + err.message),
            { enableHighAccuracy: true, timeout: 8000 }
          );
        }

        return React.createElement("div",{className:"rounded-2xl shadow p-5 bg-white"},
          React.createElement("h2",{className:"text-lg font-semibold mb-3"},"Your Location (required)"),
          React.createElement("div",{className:"mb-3 text-xs text-slate-600"},
            "Tap the map to drop a pin on the ice, or use GPS. Pin is required to place an order."
          ),
          React.createElement("div",{className:"flex gap-2 mb-3"},
            React.createElement("button",{onClick:useGPS, className:"px-3 py-2 rounded-lg bg-white border"},"Use GPS"),
            pin
              ? React.createElement("span",{className:"text-xs self-center text-slate-600"}, `Pin: ${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}`)
              : React.createElement("span",{className:"text-xs self-center text-slate-500"}, "No pin yet")
          ),
          React.createElement("div",{id:"map", className:"rounded-xl overflow-hidden border"})
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
